<html>
    <head>
        <link rel="stylesheet" href="pico.css" />
    </head>
    <body st>
        <header class="container">
            <hgroup>
                <h1> PICam </h1>
            </hgroup>
            <div class="grid">
                <button>Live</button>
                <button class="secondary">Archive</button>
            </div>
        </header>
        <main class="container">
            <video style="width: 100%;" id="player" autoplay></video>
            <progress id="progress"></progress>
        </main>
    </body>
    <script>

        let mediaSource = null;
        let video = document.getElementById('player');
        let sourceBuffer = null;

        video.ontimeupdate = () => {
            if (sourceBuffer) {
                document.getElementById("progress").style.visibility = "hidden";

                let length = sourceBuffer.buffered.length;
                let seconds = sourceBuffer.buffered.end(sourceBuffer.buffered.length - 1);
                if (seconds - video.currentTime > 5) {
                    video.playbackRate = 1.5;
                } else if (seconds - video.currentTime < 0.75) {
                    video.playbackRate = 0.25;
                } else {
                    video.playbackRate = 1.0;
                }
            } 
        }

        function createVideoSource() {
            mediaSource = new MediaSource();
            video.src = URL.createObjectURL(mediaSource);

            mediaSource.addEventListener("sourceopen", this.onSourceOpen);
            video.load();
        }
        let opend = false;

        function onSourceOpen() {
            if (opend) {
                return;
            }
            opend = true;

            let codec = 'video/mp4; codecs="avc1.42E01e"';
            if (!MediaSource.isTypeSupported(codec)) {
                console.error("Codec not supported");
                return;
            }
            sourceBuffer = mediaSource.addSourceBuffer(codec);
            sourceBuffer.mode = "sequence";
            sourceBuffer.addEventListener("updateend", () => {

            });



            const socket = new WebSocket("ws://localhost:3000/ws");


            // Listen for messages
            socket.addEventListener("message", async (event) => {
                let data = await event.data.arrayBuffer();
                addToBuffer(data);
            });

        }

        createVideoSource();

        let collectedData = [];

        function addToBuffer(data) {
            collectedData.push(data);
            if (sourceBuffer) {
                if (!sourceBuffer.updating) {
                    let seg = collectedData.shift();
                    if (seg) {
                        sourceBuffer.appendBuffer(seg);
                    }
                }
            }
        }


    </script>
</html>