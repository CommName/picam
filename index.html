<html>

<head>
    <link rel="stylesheet" href="pico.css" />
</head>

<body st>
    <header class="container">
        <hgroup>
            <h1> PICam </h1>
        </hgroup>
        <div class="grid">
            <button id="goToLivePageButton" onclick="goToLivePage()">Live</button>
            <button id="goToArchivePageButton" class="secondary" onclick="goToArchivePage()">Archive</button>
        </div>
    </header>
    <main class="container">
        <div class="container" id="archive">
            <details class="dropdown">
                <summary role="button" class="secondary">Select archive</summary>
                <ul id="archiveList">
                </ul>
              </details>
        </div>
        <video style="width: 100%;" id="player" autoplay></video>
        <progress id="progress"></progress>
    </main>
</body>
<script>
    let video = document.getElementById('player');
    let mediaSource = null;
    let sourceBuffer = null;
    let socket = null;
    let collectedData = [];
    let opened = false;

    function goToLivePage() {
        document.getElementById("goToLivePageButton").className = "";
        document.getElementById("goToArchivePageButton").className = "secondary";
        document.getElementById("progress").style.visibility = "visible";
        removeVideoSrc();
        createVideoSource();
    }

    function goToArchivePage() {
        document.getElementById("goToLivePageButton").className = "secondary";
        document.getElementById("goToArchivePageButton").className = "";

        if (socket != null) {
            socket.close(1000);
        }
        removeVideoSrc();
        document.getElementById("progress").style.visibility = "hidden";
        refreshArchive();
    }

    function refreshArchive() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                let archive = JSON.parse(xhttp.responseText);
                let list = document.getElementById("archiveList");
                list.innerHTML = "";

                archive.forEach(recording => {
                    let listElement = document.createElement("li");
                    let link = document.createElement("a");
                    link.innerHTML = recording;
                    listElement.appendChild(link);
                    list.appendChild(listElement);
                });
            }
        };
        xhttp.open("GET", "http://localhost:3000/api/recordings", true);
        xhttp.send();
    }
    
    function removeVideoSrc() {
        video.removeAttribute('src');
        video.load();
        if (mediaSource != null) {
            delete mediaSource;
            mediaSource = null;
        }
    }

    video.ontimeupdate = () => {
        if (sourceBuffer) {
            document.getElementById("progress").style.visibility = "hidden";

            let length = sourceBuffer.buffered.length;
            let seconds = sourceBuffer.buffered.end(sourceBuffer.buffered.length - 1);
            if (seconds - video.currentTime > 5) {
                video.playbackRate = 1.5;
            } else if (seconds - video.currentTime < 0.75) {
                video.playbackRate = 0.25;
            } else {
                video.playbackRate = 1.0;
            }
        }
    }

    function createVideoSource() {
        opened = false;
        mediaSource = new MediaSource();
        mediaSource.addEventListener("sourceopen", this.onSourceOpen);
        
        video.src = URL.createObjectURL(mediaSource);
        video.load();
    }


    function onSourceOpen() {

        if (opened) {
            return;
        }
        opened = true;

        let codec = 'video/mp4; codecs="avc1.42E01e"';
        if (!MediaSource.isTypeSupported(codec)) {
            console.error("Codec not supported");
            return;
        }
        sourceBuffer = mediaSource.addSourceBuffer(codec);
        sourceBuffer.mode = "sequence";
        sourceBuffer.addEventListener("updateend", () => {

        });

        function addToBuffer(data) {
            collectedData.push(data);
            if (sourceBuffer) {
                while(!sourceBuffer.updating) {
                    let seg = collectedData.shift();
                    if (seg) {
                        sourceBuffer.appendBuffer(seg);
                    }
                }
            }
        }


        // Open websocket
        socket = new WebSocket("ws://localhost:3000/ws");

        socket.addEventListener("message", async (event) => {
            let data = await event.data.arrayBuffer();
            addToBuffer(data);
        });

    }

    createVideoSource();




</script>

</html>