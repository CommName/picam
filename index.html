<html>
    <head>
    </head>
    <body>
        Hello world
        <video id="player" autoplay controls></video>
    </body>
    <script>

        let mediaSource = null;
        let video = document.getElementById('player');
        let sourceBuffer = null;

        video.ontimeupdate = () => {
            let length = sourceBuffer.buffered.length;
            let seconds = sourceBuffer.buffered.end(sourceBuffer.buffered.length - 1);
            if (seconds - video.currentTime > 5) {
                video.playbackRate = 1.5;
            } else if (seconds - video.currentTime < 1.5) {
                video.playbackRate = 0.25;
            } else {
                video.playbackRate = 1.0;
            }
        }

        function createVideoSource() {
            mediaSource = new MediaSource();
            video.src = URL.createObjectURL(mediaSource);

            mediaSource.addEventListener("sourceopen", this.onSourceOpen);
            video.load();
        }
        let opend = false;

        function onSourceOpen() {
            console.log("Adding new buffer: ", mediaSource.readyState);
            if (opend) {
                return;
            }
            opend = true;

            let codec = 'video/mp4; codecs="avc1.42E01e"';
            if (MediaSource.isTypeSupported(codec)) {
                console.log("Codec supported");
            }
            sourceBuffer = mediaSource.addSourceBuffer(codec);
            sourceBuffer.mode = "sequence";
            sourceBuffer.addEventListener("updateend", () => {
                //mediaSource.endOfStream();
                //video.play();
                //sourceBuffer.timestampOffset = 0;

            });

            


            const socket = new WebSocket("ws://localhost:3000/ws");

            socket.addEventListener("open", (event) => {
            });

            // Listen for messages
            socket.addEventListener("message", async (event) => {
                let data = await event.data.arrayBuffer();
                addToBuffer(data);
            });

            //sourceBuffer.addEventListener(
            //    "updateend",
            //    onBufferUpdateCallback
            //);
        }

        createVideoSource();

        //URL.revokeObjectURL(this.txPlayer.video.src);

        let collectedData = [];

        function addToBuffer(data) {
            collectedData.push(data);
            if (sourceBuffer) {
                if (!sourceBuffer.updating) {
                    let seg = collectedData.shift();
                    //console.log(mediaSource.sourceBuffers[0].buffered);
                    if (seg) {
                        sourceBuffer.appendBuffer(seg);
                    }
                }
            }
        }


    </script>
</html>